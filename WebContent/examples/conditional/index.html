<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Crafty</title>
    <style>
    body, html { margin:0; padding: 0; overflow:hidden; font-family:Arial; font-size:20px }
    
    #cr-stage{
    	margin:0 auto;
    }
    
    #chat{
    	background:#eee;
    	width:640px;
    	margin:0 auto;
    	padding:0.5em 0;    	
    }
    
    #chat ul{
    	margin:0;
    	padding:0;
    }
    
    #chat p, #chat li{
    	margin:0;
    	font-size:80%;  
    	padding:0 0.5em;
    	cursor:pointer;   	
    }
                   
    </style>  
  </head>
  <body>
    
    <script src="../../libs/crafty.js"></script>
    <script src="js/datasource.js"></script> 
    <script src="js/tiledmapbuilder.js"></script>
    <script src="../../dialogues.js"></script>     
	<script>
  		window.onload = function() {  	
  			  			  			  			  	
  			var BOARD_WIDTH = 640;
  			var BOARD_HEIGHT = 640;  			
  			Crafty.init(BOARD_WIDTH, BOARD_HEIGHT);  			  		
  			Crafty.scene("Load", function() {
				
  				//Preload sprites first
  				 Crafty.load([
  				              "../../img/ground.png",
  				              "../../img/equipment.png",
  				              "../../img/ogre.png",
  				             ], function() {
  					 
  					 Crafty.sprite(50,67,"../../img/ogre.png", {
  						 Ogre:[0,0]
  					 }); 
  					  					
  					Crafty.scene("Main");		
  					});  				
  			});
  			
  			Crafty.scene("Load");
  			  			  		
			Crafty.scene("Main", function () {
				
				Crafty.e("2D, DOM, TiledMapBuilder").createWorld( SOURCE_FROM_TILED_MAP_EDITOR, function( tiledmap ){
								
					tiledmap.getLayer('head1')[4].addComponent("Obstacle, Collision").collision();
					tiledmap.getLayer('head1')[5].addComponent("Obstacle, Collision").collision();
				
					for (var obstacle = 0; obstacle < tiledmap.getLayer('head1').length; obstacle++){
						tiledmap.getLayer('head1')[obstacle]														
							.z = Math.floor(tiledmap.getLayer('head1')[obstacle]._y + tiledmap.getLayer('head1')[obstacle]._h);						
					}									
				});
																								
				Crafty.e("2D, DOM, Mouse, GameDesk")
				.attr({x:0,y:0,w:BOARD_WIDTH,h:BOARD_HEIGHT})
				.bind("Click", function(){          	        	
		        	Crafty.trigger("ClickToDesk", {x:Crafty.mousePos.x, y:Crafty.mousePos.y});		        	
		        }); 
				
				Crafty.e("2D, DOM, Mouse, Head1, Dialogues, Collision")
				.attr({x: Crafty("TiledMapBuilder").getLayer('head1')[0]._x-5, y: Crafty("TiledMapBuilder").getLayer('head1')[0]._y-5, w:64+10, h:96+10})					
				.collision()
				.setDialogues( CHATBUILDER_SOURCE )								
				.bind("Click", function(){ 					
					Crafty.trigger("ClickToDesk", {x:Crafty.mousePos.x, y:Crafty.mousePos.y}); 
					this.wantTalk = true;					
		        })	
		        .onHit("Ogre", function(){		        
		        	if(this.wantTalk){
		        		this.showDialogue();		        		        				        				        
		        		this.wantTalk = false;
		        	}
		        })		      
				.bind("MouseOver", function(){          	        	
					for (var head = 0; head < Crafty("TiledMapBuilder").getLayer('head1').length; head++){
						Crafty("TiledMapBuilder").getLayer('head1')[head]						
						.attr({alpha:0.8})
					}    
		        })
		        .bind("MouseOut", function(){          	        	
					for (var head = 0; head < Crafty("TiledMapBuilder").getLayer('head1').length; head++){
						Crafty("TiledMapBuilder").getLayer('head1')[head]						
						.attr({alpha:1})
					}    
		        })
		        .bind("ClickToDesk", function(){          	        	
		        	this.endOfConversation();	
		        })
		        		       	       		       		        		       		       						
				Crafty.e("2D, DOM, SpriteAnimation, Ogre, Collision")
			   		.attr({x: 50, y: 500, z: 10, speed:2}) 
			   		.animate("walk_left", 0, 1, 3)
			   		.animate("walk_right", 0, 2, 3)	
			   		.animate("walk_up", 0, 3, 3)	
			   		.animate("walk_down", 0, 0, 3)				   		   				
			   		.collision( new Crafty.polygon([10,60],[40,60],[40,67],[10,67]) )			   	
					.bind("ClickToDesk", function( position ){						
						if( this._x != position.x && 
					        this._y != position.y ){
							
							this.targetX = position.x - this._w/2;
							this.targetY = position.y - this._h/2;
														
							var dx = this.targetX - this.x;
		    	            var dy = this.targetY - this.y;
		    	            
		    	            if(Math.abs(dx) > Math.abs(dy)){
		    	            	
		    	            	//x move
		    	            	if(dx >0){		    	            		 	
		    	            		this.stop().animate("walk_right", 10, -1);	
		    	            	}else{
		    	            		this.stop().animate("walk_left", 10, -1);
		    	            	}
		    	            			    	            	
		    	            }else{
		    	            	//y move
		    	            	if(dy >0){
		    	            		this.stop().animate("walk_down", 10, -1);	
		    	            	}else{
		    	            		this.stop().animate("walk_up", 10, -1);
		    	            	}
		    	            	
		    	            }
														
							this.moving = true;
						}										            
				})
				.bind("Moved", function( from ){	
					
					if( this.hit('Obstacle') ){						
						this.attr({x: from.x, y:from.y});
						this.targetX = this._x;
						this.targetY = this._y;						
					}
					
					this.z = Math.floor(this._y + this._h);  
		        })
		     	        
				.bind("EnterFrame", function(e) {
														
					if(this.moving) {						
		 				  var dx = this.targetX - this.x;
	    	              var dy = this.targetY - this.y; 
	    	          	    	            
	    	              var distance = Math.sqrt((dx*dx)+(dy*dy));

	    	              dx = dx/distance;
	    	              dy = dy/distance;
	    	             
	    	              this.x += dx*this.speed;
	    	              this.y += dy*this.speed;
	    	              this.trigger('Moved', { x:this.x - dx*this.speed, y: this.y - dy*this.speed});
	    	              
	    	              
	    	              if ((dx > 0 && this.x + this.speed >= this.targetX) || 
	    	            	  (dx < 0 && this.x - this.speed <= this.targetX)) {
	    	                    this.x = this.targetX
	    	                }
	    	              if ((dy > 0 && this.y + this.speed >= this.targetY) || 
	    	            	  (dy < 0 && this.y - this.speed <= this.targetY)) {
	    	                    this.y = this.targetY
	    	                }
	    	          
	    	              if (this.x == this.targetX && this.y == this.targetY) {
	    	                    this.moving = false;
	    	                    this.stop();
	    	                }
		 			}
										
		 		})																		   	
  			});  					
  	}	
	</script>	
	<p align="center">Use mouse for moving player. Click on the heads for an dialogues.</p>			
	<div id="cr-stage"></div>
	<div id="chat"></div>
																													
  </body>
</html>
